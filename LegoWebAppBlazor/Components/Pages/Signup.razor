@page "/signup"
@inject SupabaseAuthService Auth
@inject AuthStateService AuthState
@inject NavigationManager Nav

<PageTitle>Sign Up</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-6">
        <h1 class="mb-4">Sign Up</h1>

        @if (_errorMessage is not null)
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }

        <EditForm Model="_signupModel" OnValidSubmit="HandleSignup" FormName="signup">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Email</label>
                <InputText @bind-Value="_signupModel.Email" class="form-control" type="email" />
                <ValidationMessage For="() => _signupModel.Email" />
            </div>

            <div class="mb-3">
                <label class="form-label">Password</label>
                <InputText @bind-Value="_signupModel.Password" class="form-control" type="password" />
                <ValidationMessage For="() => _signupModel.Password" />
                <div class="form-text">Minimum 6 characters.</div>
            </div>

            <button type="submit" class="btn btn-success w-100" disabled="@_loading">
                @(_loading ? "Creating account..." : "Create Account")
            </button>
        </EditForm>

        <p class="mt-3 text-center">
            Already have an account? <a href="/login">Login</a>
        </p>
    </div>
</div>

@code {
    private SignupFormModel _signupModel = new();
    private string? _errorMessage;
    private bool _loading;

    protected override void OnInitialized()
    {
        if (AuthState.IsLoggedIn())
            Nav.NavigateTo("/");
    }

    private async Task HandleSignup()
    {
        _errorMessage = null;
        _loading = true;

        var result = await Auth.SignUpAsync(_signupModel.Email, _signupModel.Password);

        if (!result.Success)
        {
            _errorMessage = result.ErrorMessage ?? "Signup failed.";
            _loading = false;
            return;
        }

        // If Supabase returned a token immediately (email confirmation disabled),
        // log the user in and go to their collection.
        if (result.Token is not null)
        {
            AuthState.Login(result.Token);
            Nav.NavigateTo("/");
            return;
        }

        // Otherwise, redirect to login with a message to check their email.
        var msg = Uri.EscapeDataString(result.ErrorMessage ?? "Check your email to confirm your account.");
        Nav.NavigateTo($"/login?message={msg}");
    }

    private class SignupFormModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = "";

        [Required, MinLength(6)]
        public string Password { get; set; } = "";
    }
}
